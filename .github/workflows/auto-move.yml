name: Move linked issue to "In Review"

on:
  pull_request:
    types: [opened, reopened]

jobs:
  move-to-review:
    runs-on: ubuntu-latest
    steps:
      - name: Move linked issues to In Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_PAT }}
          script: |
            const pr = context.payload.pull_request;
            const owner = 'orgs/365Soft-Bolivia'; // Tu organización
            const projectNumber = 4; // Número de tu proyecto
            
            // Extraer números de issues del cuerpo del PR
            const body = pr.body || '';
            const regex = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?\s*#(\d+)/gi;
            const matches = [...body.matchAll(regex)];
            const issueNumbers = matches.map(m => parseInt(m[1]));
            
            if (issueNumbers.length === 0) {
              console.log('No se encontraron issues vinculados');
              return;
            }
            
            console.log(`Issues encontrados: ${issueNumbers.join(', ')}`);
            
            // Query para obtener info del proyecto
            const projectQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            let projectData;
            try {
              projectData = await github.graphql(projectQuery, {
                org: '365Soft-Bolivia',
                number: projectNumber
              });
            } catch (error) {
              console.error('Error obteniendo proyecto:', error);
              return;
            }
            
            const project = projectData.organization.projectV2;
            const statusField = project.field;
            
            // Buscar opción "In review" (case insensitive)
            const inReviewOption = statusField.options.find(
              opt => opt.name.toLowerCase() === 'in review'
            );
            
            if (!inReviewOption) {
              console.error('No se encontró la columna "In review"');
              console.log('Columnas disponibles:', statusField.options.map(o => o.name));
              return;
            }
            
            // Procesar cada issue
            for (const issueNumber of issueNumbers) {
              try {
                // Buscar el item del issue en el proyecto
                const itemQuery = `
                  query($org: String!, $repo: String!, $issueNum: Int!) {
                    repository(owner: $org, name: $repo) {
                      issue(number: $issueNum) {
                        id
                        projectItems(first: 10) {
                          nodes {
                            id
                            project {
                              id
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const itemData = await github.graphql(itemQuery, {
                  org: '365Soft-Bolivia',
                  repo: context.repo.repo,
                  issueNum: issueNumber
                });
                
                const projectItem = itemData.repository.issue.projectItems.nodes.find(
                  item => item.project.number === projectNumber
                );
                
                if (!projectItem) {
                  console.log(`⚠️ Issue #${issueNumber} no está en el proyecto`);
                  continue;
                }
                
                // Actualizar status
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { singleSelectOptionId: $optionId }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;
                
                await github.graphql(updateMutation, {
                  projectId: project.id,
                  itemId: projectItem.id,
                  fieldId: statusField.id,
                  optionId: inReviewOption.id
                });
                
                console.log(`✅ Issue #${issueNumber} movido a "In review"`);
                
              } catch (error) {
                console.error(`❌ Error con issue #${issueNumber}:`, error.message);
              }
            }
